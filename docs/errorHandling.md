# エラー処理の基本方針

- common配下はエラーが起こらない前提で進める。
- common/error配下は特に気を付ける。
  - エラー発生→common/error配下で処理→その中でエラー発生→common/error配下で処理→…の無限ループに気を付ける。
- lib配下は、以下の方針で進める。
  - coincheck配下はResult型で返却し、APIリクエスト部分のエラーについては専用のクラス「Vcat2」を用意する。
  - express配下は、リクエストハンドリングの処理全体をResult化し、エラー時は500で対応する。
  - slack配下は、どうしよう。
  - typeorm配下は、いったんDBアクセスのみなので、いったん安全神話で押し通したい。ただ、設計がイケてないとリクエストのタイムアウトがあったりするかも。。。
- domain配下は、以下の方針で進める。
  - MarketMonitorに関するエラーは、ペナルティー制度とする。
    エラーが起きたらペナルティーを加算してスルーする。
    n秒たったらペナルティーを-1する。
    一定値を超えたらSlackに通知する。
  - StrategyBoxに関する処理は、事前準備と事後処理で分ける。
    事前準備は、MarketMonitorと同じくペナルティー制度とする。
    ペナルティーはSB単位とする。
    事後処理で起きた場合は、即刻status=errorとしてストップし、Slack通知する。
- 実装面は以下のとおり。基本はsrc/common/error配下にまとまっている。
  - Result型を作り、これをベースにする。
  - エラー情報は、Vcat2Errorクラスを作り、これを継承する。
  - 汎用ラップ関数`e`と`ea`を作り、これを利用する。
